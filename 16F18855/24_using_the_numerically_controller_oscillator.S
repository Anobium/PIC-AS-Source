;Program compiled by Great Cow BASIC (0.98.<<>> 2021-02-09 (Windows 64 bit)) for Microchip PIC-AS
;Need help? See the GCBASIC forums at http://sourceforge.net/projects/gcbasic/forums,
;check the documentation or email evan+picas at anobium  dot co dot uk.

;********************************************************************************


;Set up the assembler options (Chip type, clock source, other bits and pieces)
;PROCESSOR   16F18855
 PAGEWIDTH   132
 RADIX       DEC
 TITLE       "D:\GCB@Syn39\GreatCowBasic\Demos\vendor_boards\mplab_xpress_board_pic16f18855\24_using_the_numerically_controller_oscillator.S"
 SUBTITLE    "02-10-2021"

; Reverse lookup file
; C:\Program Files\Microchip\xc8\v2.31\pic\include\proc\pic16f18855.inc

 #include <xc.inc>

;********************************************************************************
;Explicit PIC-AS constants to resolve the crazyness of the PIC-AS syntax
;These are therefore the same as MPASM
#define BANKED b
#define ACCESS a
#define UPPER low highword

;********************************************************************************
;Explicit CONFIG
 CONFIG FCMEN = ON
 CONFIG CLKOUTEN = ON
 CONFIG RSTOSC = HFINT32
 CONFIG FEXTOSC = OFF
 CONFIG MCLRE = OFF
 CONFIG WDTE = OFF
 CONFIG LVP = OFF
 CONFIG WRT = OFF
 CONFIG CPD = OFF
 CONFIG CP = OFF
;Inferred CONFIG

;********************************************************************************

;Set aside RAM memory locations for variables. All variables are global.
 DELAYTEMP                        EQU 112                    ; 0X70
 DELAYTEMP2                       EQU 113                    ; 0X71
 INC_VAL                          EQU 32                    ; 0X20
 INC_VAL_E                        EQU 35                    ; 0X23
 INC_VAL_H                        EQU 33                    ; 0X21
 INC_VAL_U                        EQU 34                    ; 0X22
 SYSWAITTEMPMS                    EQU 114                    ; 0X72
 SYSWAITTEMPMS_H                  EQU 115                    ; 0X73
 SYSWAITTEMPS                     EQU 116                    ; 0X74

;********************************************************************************

 PSECT   RESETVEC,delta=2, abs
 RESETVEC:
;VECTORS
	ORG	0
	PAGESEL	BASPROGRAMSTART
	GOTO	BASPROGRAMSTART
	ORG	4
	RETFIE

;********************************************************************************

;START OF PROGRAM MEMORY PAGE 0
	ORG	5
BASPROGRAMSTART:
;CALL INITIALISATION ROUTINES
	CALL	INITSYS
	CALL	INITPPS

;START OF THE MAIN PROGRAM
;''A demonstration program for GCGB and GCB.
;''--------------------------------------------------------------------------------------------------------------------------------
;''This program demonstrates the Numerically Controlled Oscillator capabilities of the microcontroller.
;''This program will use the LEDs to show the different frequencies plus Portc.3 and the LEDs for your scope.
;''
;''
;''@author  BillR
;''@licence GPL
;''@version 1.00
;''@date    02.04.2016
;''********************************************************************************
;----- Configuration
;Generated by PIC PPS Tool for Great Cow Basic
;PPS Tool version: 0.0.5.5
;PinManager data: 07/03/2017
;
;Template comment at the start of the config file
;
;Template comment at the end of the config file
;No Constants specified in this example.
;----- Define Hardware setting
;Reference for your Scopr
;Dir PORTC.3 Out
	BCF	TRISC,3
;#DEFINE LEDD2 PORTA.0
;#DEFINE LEDD3 PORTA.1
;#DEFINE LEDD4 PORTA.2
;#DEFINE LEDD5 PORTA.3
;Dir     LEDD2 Out
	BCF	TRISA,0
;Dir     LEDD3 Out
	BCF	TRISA,1
;Dir     LEDD4 Out
	BCF	TRISA,2
;Dir     LEDD5 Out
	BCF	TRISA,3
;----- Variables
;Dim INC_VAL_U, INC_VAL_H As Byte
;----- Main body of program commences here.
;Configure the Numerically Controlled Oscillator capabilities
;FOSC (ChipMhz)
;NCO1CLK = 0
BANKSEL	NCO1CLK
CLRF	NCO1CLK
;Enable NCO
;Set N1EN On
;B7: ASM Source was:  BSF NCO1CON,N1EN
	BSF	NCO1CON,7
;Sets initially Frequency of NCO to 12Khz
;WRITE_NCO1INC 787
	MOVLW	19
	BANKSEL	INC_VAL
	MOVWF	INC_VAL
	MOVLW	3
	MOVWF	INC_VAL_H
	CLRF	INC_VAL_U
	CLRF	INC_VAL_E
	CALL	WRITE_NCO1INC
;Do
SYSDOLOOP_S1:
;Freq Out = ((Clock_Freq  * INCREMENT_VAL) / 1048576) /2 = 12.007KHz
;and where INCREMENT_VAL = 2097152 * Desired Freq Out/Clock_Freq
;so,  INCREMENT_VAL = 2097152 * Desired Freq Out/ ChipMHz
;so, INCREMENT_VAL = 2097152 * 12000[hz] / 32000000
;INCREMENT_VAL = 787
;12Khz
;WRITE_NCO1INC 787
	MOVLW	19
	MOVWF	INC_VAL
	MOVLW	3
	MOVWF	INC_VAL_H
	CLRF	INC_VAL_U
	CLRF	INC_VAL_E
	CALL	WRITE_NCO1INC
;Wait 5 sec
	MOVLW	5
	MOVWF	SYSWAITTEMPS
	CALL	DELAY_S
;24KHz
;WRITE_NCO1INC 1574
	MOVLW	38
	MOVWF	INC_VAL
	MOVLW	6
	MOVWF	INC_VAL_H
	CLRF	INC_VAL_U
	CLRF	INC_VAL_E
	CALL	WRITE_NCO1INC
;Wait 5 s
	MOVLW	5
	MOVWF	SYSWAITTEMPS
	CALL	DELAY_S
;48Khz
;WRITE_NCO1INC 3148
	MOVLW	76
	MOVWF	INC_VAL
	MOVLW	12
	MOVWF	INC_VAL_H
	CLRF	INC_VAL_U
	CLRF	INC_VAL_E
	CALL	WRITE_NCO1INC
;Wait 5 s
	MOVLW	5
	MOVWF	SYSWAITTEMPS
	CALL	DELAY_S
;48Khz
;WRITE_NCO1INC 3148
	MOVLW	76
	MOVWF	INC_VAL
	MOVLW	12
	MOVWF	INC_VAL_H
	CLRF	INC_VAL_U
	CLRF	INC_VAL_E
	CALL	WRITE_NCO1INC
;Wait 5 s
	MOVLW	5
	MOVWF	SYSWAITTEMPS
	CALL	DELAY_S
;1Khz
;WRITE_NCO1INC 65
	MOVLW	65
	MOVWF	INC_VAL
	CLRF	INC_VAL_H
	CLRF	INC_VAL_U
	CLRF	INC_VAL_E
	CALL	WRITE_NCO1INC
;Wait 5 s
	MOVLW	5
	MOVWF	SYSWAITTEMPS
	CALL	DELAY_S
;Loop
	GOTO	SYSDOLOOP_S1
SYSDOLOOP_E1:
;----- Support methods.  Subroutines and Functions
BASPROGRAMEND:
	SLEEP
	GOTO	BASPROGRAMEND

;********************************************************************************

DELAY_MS:
	INCF	SYSWAITTEMPMS_H, F
DMS_START:
	MOVLW	14
	MOVWF	DELAYTEMP2
DMS_OUTER:
	MOVLW	189
	MOVWF	DELAYTEMP
DMS_INNER:
	DECFSZ	DELAYTEMP, F
	GOTO	DMS_INNER
	DECFSZ	DELAYTEMP2, F
	GOTO	DMS_OUTER
	DECFSZ	SYSWAITTEMPMS, F
	GOTO	DMS_START
	DECFSZ	SYSWAITTEMPMS_H, F
	GOTO	DMS_START
	RETURN

;********************************************************************************

DELAY_S:
DS_START:
	MOVLW	232
	MOVWF	SYSWAITTEMPMS
	MOVLW	3
	MOVWF	SYSWAITTEMPMS_H
	CALL	DELAY_MS
	DECFSZ	SYSWAITTEMPS, F
	GOTO	DS_START
	RETURN

;********************************************************************************

;SOURCE: 24_USING_THE_NUMERICALLY_CONTROLLER_OSCILLATOR.GCB (28)
INITPPS:
;Module: NCO1
;NCO > RA0
;RA0PPS = 0x0019
	MOVLW	25
BANKSEL	RA0PPS
MOVWF	RA0PPS
;NCO > RA1
;RA1PPS = 0x0019
	MOVLW	25
MOVWF	RA1PPS
;NCO > RA2
;RA2PPS = 0x0019
	MOVLW	25
MOVWF	RA2PPS
;NCO > RA3
;RA3PPS = 0x0019
	MOVLW	25
MOVWF	RA3PPS
;NCO > RC3
;RC3PPS = 0x0019
	MOVLW	25
MOVWF	RC3PPS
BANKSEL	STATUS
	RETURN

;********************************************************************************

;SOURCE: SYSTEM.H (129)
INITSYS:
;asm showdebug This code block sets the internal oscillator to ChipMHz
;asm showdebug Default settings for microcontrollers with _OSCCON1_
;Default OSCCON1 typically, NOSC HFINTOSC; NDIV 1 - Common as this simply sets the HFINTOSC
;OSCCON1 = 0x60
	MOVLW	96
BANKSEL	OSCCON1
MOVWF	OSCCON1
;Default value typically, CSWHOLD may proceed; SOSCPWR Low power
;OSCCON3 = 0x00
CLRF	OSCCON3
;Default value typically, MFOEN disabled; LFOEN disabled; ADOEN disabled; SOSCEN disabled; EXTOEN disabled; HFOEN disabled
;OSCEN = 0x00
CLRF	OSCEN
;Default value
;OSCTUNE = 0x00
CLRF	OSCTUNE
;asm showdebug The MCU is a chip family ChipFamily
;asm showdebug OSCCON type is 102
;Set OSCFRQ values for MCUs with OSCSTAT... the 16F18855 MCU family
;OSCFRQ = 0b00000110
	MOVLW	6
MOVWF	OSCFRQ
;asm showdebug _Complete_the_chip_setup_of_BSR,ADCs,ANSEL_and_other_key_setup_registers_or_register_bits
;Ensure all ports are set for digital I/O and, turn off A/D
;SET ADFM OFF
BANKSEL	ADCON0
;B7: ASM Source was:  BCF ADCON0,ADFRM0
	BCF	ADCON0,2
;Switch off A/D Var(ADCON0)
;SET ADCON0.ADON OFF
;B7: ASM Source was:  BCF ADCON0,ADON
	BCF	ADCON0,7
;ANSELA = 0
BANKSEL	ANSELA
CLRF	ANSELA
;ANSELB = 0
CLRF	ANSELB
;ANSELC = 0
CLRF	ANSELC
;Set comparator register bits for many MCUs with register CM2CON0
;C2ON = 0
BANKSEL	CM2CON0
;B7: ASM Source was:  BCF CM2CON0,C2ON
	BCF	CM2CON0,7
;C1ON = 0
;B7: ASM Source was:  BCF CM1CON0,C1ON
	BCF	CM1CON0,7
;
;'Turn off all ports
;PORTA = 0
BANKSEL	PORTA
CLRF	PORTA
;PORTB = 0
CLRF	PORTB
;PORTC = 0
CLRF	PORTC
;PORTE = 0
CLRF	PORTE
	RETURN

;********************************************************************************

;SOURCE: 24_USING_THE_NUMERICALLY_CONTROLLER_OSCILLATOR.GCB (110)
WRITE_NCO1INC:
;NCO1INCU = INC_VAL_U
	MOVF	INC_VAL_U,W
BANKSEL	NCO1INCU
MOVWF	NCO1INCU
;NCO1INCH = INC_VAL_H
	BANKSEL	INC_VAL_H
	MOVF	INC_VAL_H,W
BANKSEL	NCO1INCH
MOVWF	NCO1INCH
;NCO1INCL = INC_VAL
	BANKSEL	INC_VAL
	MOVF	INC_VAL,W
BANKSEL	NCO1INCL
MOVWF	NCO1INCL
BANKSEL	STATUS
	RETURN

;********************************************************************************

;START OF PROGRAM MEMORY PAGE 1
	ORG	2048
;START OF PROGRAM MEMORY PAGE 2
	ORG	4096
;START OF PROGRAM MEMORY PAGE 3
	ORG	6144
	ALIGN	2;X2
;
; Declare Power-On-Reset entry point
;
 END     RESETVEC
